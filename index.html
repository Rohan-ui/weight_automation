<!DOCTYPE html>
<html>
<head>
    <title>Weight Reader & Production Entry</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .connected {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .disconnected {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        #weight-display, .form-section {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        select, input, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        #save-btn, #print-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #save-btn {
            background-color: #4CAF50;
            color: white;
        }
        #print-btn {
            background-color: #2196F3;
            color: white;
        }
        #save-btn:hover {
            background-color: #45a049;
        }
        #print-btn:hover {
            background-color: #1976D2;
        }
        .form-section {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 10px; /* Reduce space below form */
}
          /* General Table Styling */
          .table-section {
    width: 100%;
    padding: 0 20px; /* Remove extra top padding */
    background-color: #f8f9fa;
    margin-top: 0; /* Remove the extra space */
}


    .table-section h2 {
        text-align: center;
        margin-bottom: 15px;
        color: #333;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    /* Table Header Styling */
    .data-table thead tr {
        background-color: #007BFF;
        color: white;
        text-transform: uppercase;
    }

    .data-table th, .data-table td {
    padding: 8px; /* Reduce padding for a compact table */
    border: 1px solid #ddd;
    text-align: center;
}

    /* Alternate Row Colors */
    .data-table tbody tr:nth-child(odd) {
        background-color: #f2f2f2;
    }

    .data-table tbody tr:nth-child(even) {
        background-color: #ffffff;
    }

    /* Hover Effect */
    .data-table tbody tr:hover {
        background-color: #d3e5ff;
    }

    /* Button Styling */
    .print-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
    }

    .print-btn:hover {
        background-color: #218838;
    }

    /* Make Table Cover Full Page */
    .table-section {
    display: block;
}

    .data-table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
}
@media print {
        @page {
            size: A4;
            margin: 0;
        }

        body {
            margin: 0;
            padding: 0;
            visibility: hidden;
        }

        .print-container {
            visibility: visible;
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            display: flex !important;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        .print-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 2px solid black;
        }

        .print-table tr {
            height: calc(100% / 12);
        }

        .print-table .label {
            width: 50%;
            border-right: 2px solid black;
            padding: 10px;
            padding-left: 20px;
            font-weight: bold;
            font-size: 20px;
            line-height: 1.2;
        }

        .print-table .value {
            width: 50%;
            padding: 10px;
            padding-left: 100px;
            font-weight: bold;
            font-size: 20px;
            line-height: 1.2;
            text-align: left;
        }

        /* Add bottom border to all cells except last row */
        .print-table tr:not(:last-child) td {
            border-bottom: 2px solid black;
        }

        /* Hide everything else when printing */
        .controls, .form-section, .table-section {
            display: none !important;
        }
    }

    /* Regular display styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid black;
    }

    .print-table .label {
        border-right: 2px solid black;
        padding: 10px;
        padding-left: 20px;
        font-weight: bold;
        font-size: 20px;
    }

    .print-table .value {
        padding: 10px;
        padding-left: 100px;
        font-weight: bold;
        font-size: 20px;
        text-align: left;
    }

    /* Add bottom border to all cells except last row */
    .print-table tr:not(:last-child) td {
        border-bottom: 2px solid black;
    }

    /* Regular display styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid black;
    }

    .print-table .label {
        border-right: 2px solid black;
        border-bottom: 2px solid black;
        padding: 10px;
        padding-left: 20px;
        font-weight: bold;
        font-size: 20px;
    }

    .print-table .value {
        border-bottom: 2px solid black;
        padding: 10px;
        padding-left: 100px;
        font-weight: bold;
        font-size: 20px;
        text-align: left;
    }

    .print-table tr:last-child td {
        border-bottom: none;
    }

    /* Regular display styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
    }

    .print-table td {
        padding: 10px;
        font-weight: bold;
        font-size: 20px;
    }

    .print-table .label {
        border: 2px solid black;
        border-right: 2px solid black;
    }

    .print-table .value {
        border-top: none;
        border-right: none;
        border-left: none;
        border-bottom: 2px solid black;
    }

    .print-table tr:last-child .value {
        border-bottom: none;
    }

    /* Regular display styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
    }

    .print-table td {
        padding: 10px;
        font-weight: bold;
        font-size: 20px;
    }

    .print-table .label {
        border: 2px solid black;
        border-right: 2px solid black;
    }

    .print-table .value {
        border: none;
    }

    /* Regular display styling */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid black;
    }

    .print-table td {
        border: 2px solid black;
        padding: 15px;
        font-weight: bold;
        font-size: 18px;
    }

    </style>
</head>
<body>
    <div id="status" class="disconnected">Disconnected</div>
    
    <div class="controls">
        <!-- <select id="machine-select">
            <option value="">Select Machine</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select> -->
        <select id="port-select">
            <option value="">Select Port</option>
        </select>
        <button id="refresh-ports">Refresh Ports</button>
        <button id="restart-btn">Restart Connection</button>
    </div>

    <h2>Current Weight:</h2>
    <div id="weight-display">Waiting for data...</div>
    <div id="port-info"></div>

    <div class="form-section">
        <h2>Production Data Entry</h2>
        <div class="form-grid">
            <div class="form-grid">
                <select id="machine-select">
                    <option value="">Select Machine</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>

            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label>Roll No.</label>
                <input type="text" id="rollno" required>
            </div>
            <div class="form-group">
                <label>Width (mm)</label>
                <input type="number" id="width" step="0.01">
            </div>
            <div class="form-group">
                <label>Film Mic</label>
                <input type="number" id="filmmic" step="0.1">
            </div>
            <div class="form-group">
                <label>Coating</label>
                <input type="text" id="coating">
            </div>
            <div class="form-group">
                <label>Colour</label>
                <select id="colour">
                    <option value="">Select Colour</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Style</label>
                <input type="text" id="style">
            </div>
            <div class="form-group">
                <label>Length (m)</label>
                <input type="number" id="length" step="0.1">
            </div>
            <div class="form-group">
                <label>Net Weight (kg)</label>
                <input type="number" id="net-weight" readonly>
            </div>
            <div class="form-group">
                <label>Core Weight (kg)</label>
                <input type="number" id="core-weight" step="0.01">
            </div>
            <div class="form-group">
                <label>Gross Weight (kg)</label>
                <input type="number" id="gross-weight" readonly>
            </div>
            <div class="form-group">
                <label>Operator</label>
                <input type="text" id="operator" required>
            </div>
        </div>
        <div class="button-group">
            <button id="save-print-btn">Save & Print</button>
        </div>
    </div>

    <!-- Hidden print layout -->
    <div class="print-layout" style="display: none;">
    </div>

    <div class="table-section">
        <h2>Production Records</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Machine</th>
                    <th>Roll No</th>
                    <th>Width</th>
                    <th>Film Mic</th>
                    <th>Coating</th>
                    <th>Style</th>
                    <th>Length</th>
                    <th>Net Weight</th>
                    <th>Core Weight</th>
                    <th>Gross Weight</th>
                    <th>Operator</th>
                    <th class="no-print">Action</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
            </tbody>
        </table>
    </div>


        <!-- Updated print container -->
        <div class="print-container" style="display: none;">
            <table class="print-table">
                <tr><td class="label">Date</td><td class="value"></td></tr>
                <tr><td class="label">Roll No.</td><td class="value"></td></tr>
                <tr><td class="label">Width</td><td class="value"></td></tr>
                <tr><td class="label">Film Mic</td><td class="value"></td></tr>
                <tr><td class="label">Coating</td><td class="value"></td></tr>
                <tr><td class="label">Colour</td><td class="value"></td></tr>
                <tr><td class="label">Style</td><td class="value"></td></tr>
                <tr><td class="label">Length</td><td class="value"></td></tr>
                <tr><td class="label">Net Weight</td><td class="value"></td></tr>
                <tr><td class="label">Core Weight</td><td class="value"></td></tr>
                <tr><td class="label">Gross Weight</td><td class="value"></td></tr>
                <tr><td class="label">Operator</td><td class="value"></td></tr>
            </table>
        </div>
        


    <script>
        const { ipcRenderer } = require('electron');
        const statusDiv = document.getElementById('status');
        const weightDisplay = document.getElementById('weight-display');
        const portSelect = document.getElementById('port-select');
        const machineSelect = document.getElementById('machine-select');
        const refreshPortsBtn = document.getElementById('refresh-ports');
        const restartBtn = document.getElementById('restart-btn');
        const netWeightInput = document.getElementById('net-weight');
        const coreWeightInput = document.getElementById('core-weight');
        const grossWeightInput = document.getElementById('gross-weight');
        const dataTableBody = document.getElementById('data-table-body');
        
        let savedRecords = [];
        
        async function updatePortList() {
            const ports = await ipcRenderer.invoke('get-available-ports');
            portSelect.innerHTML = '<option value="">Select Port</option>';
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port.path;
                option.textContent = `${port.path} - ${port.manufacturer || 'Unknown device'}`;
                portSelect.appendChild(option);
            });
        }

        portSelect.addEventListener('change', (event) => {
            if (event.target.value) {
                ipcRenderer.send('connect-machine', {
                    port: event.target.value,
                    baudRate: 9600,
                    dataBits: 8
                });
            }
        });

        refreshPortsBtn.addEventListener('click', updatePortList);
        restartBtn.addEventListener('click', () => ipcRenderer.send('restart-serial'));

        function calculateGrossWeight() {
    const core = parseFloat(coreWeightInput.value) || 0;
    const gross = parseFloat(grossWeightInput.value) || 0;
    netWeightInput.value = (gross - core).toFixed(2);
}


function generatePrintLayout(record) {
    const printContainer = document.querySelector('.print-container');
    const cells = printContainer.querySelectorAll('.value');
    
    const values = [
        record.date.split('T')[0], // Format date to remove time
        record.rollNo,
        record.width + ' mm',
        record.filmMic + ' microns',
        record.coating + ' microns',
        record.colour,
        record.style,
        record.length + ' m',
        record.netWeight + ' kg',
        record.coreWeight + ' kg',
        record.grossWeight + ' kg',
        record.operator
    ];

    cells.forEach((cell, index) => {
        cell.textContent = values[index] || '';
    });

    printContainer.style.display = 'block';
}

function updateDataTable() {
    const dataTableBody = document.getElementById('data-table-body');
    dataTableBody.innerHTML = ''; // Clear existing content

    savedRecords.forEach((record, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.date}</td>
            <td>${record.machine}</td>
            <td>${record.rollNo}</td>
            <td>${record.width}</td>
            <td>${record.filmMic}</td>
            <td>${record.coating}</td>
            <td>${record.style}</td>
            <td>${record.length}</td>
            <td>${record.netWeight}</td>
            <td>${record.coreWeight}</td>
            <td>${record.grossWeight}</td>
            <td>${record.operator}</td>
            <td class="no-print">
                <button class="print-btn" onclick="printRecord(${index})">Print</button>
                <button class="delete-btn" onclick="deleteRecord(${index})">Delete</button>
            </td>
        `;
        dataTableBody.appendChild(row);
    });
}


function deleteRecord(index) {
    if (confirm("Are you sure you want to delete this record?")) {
        savedRecords.splice(index, 1); // Remove the selected record
        updateDataTable(); // Refresh the table
    }
}
function printRecord(index) {
    const record = savedRecords[index];
    generatePrintLayout(record);
    window.print();
    document.querySelector('.print-container').style.display = 'none';
}
// document.getElementById('print-btn').addEventListener('click', () => {
//     if (savedRecords.length === 0) {
//         alert("No records available to print.");
//         return;
//     }

//     // Print the most recent record
//     const record = savedRecords[savedRecords.length - 1];
//     generatePrintLayout(record);
//     window.print();
// });

        coreWeightInput.addEventListener('input', calculateGrossWeight);
        
        // document.getElementById('save-btn').addEventListener('click', async () => {
        //     if (!machineSelect.value) {
        //         alert('Please select a machine first');
        //         return;
        //     }
            
        //     const formData = {
        //         machine: machineSelect.value,
        //         date: new Date(document.getElementById('date').value + 'T00:00:00').toISOString(),
        //         rollNo: document.getElementById('rollno').value,
        //         width: parseFloat(document.getElementById('width').value), // Convert to number
        //         filmMic: parseFloat(document.getElementById('filmmic').value), // Convert to number
        //         coating: document.getElementById('coating').value,
        //         colour: document.getElementById('colour').value,
        //         style: document.getElementById('style').value,
        //         length: parseFloat(document.getElementById('length').value),
        //         netWeight: parseFloat(netWeightInput.value),
        //         coreWeight: parseFloat(coreWeightInput.value),
        //         grossWeight: parseFloat(grossWeightInput.value),
        //         operator: document.getElementById('operator').value
        //     };
        //     console.log("saved", formData)
        //     savedRecords.push(formData);
        //     updateDataTable();
            
        //             try {
        //         const response = await fetch('https://deverp.shantipatra.com/api/production-rolls', {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json'
        //             },
        //             body: JSON.stringify(formData)
        //         });

        //         const result = await response.json();

        //         if (response.ok) {
        //             console.log("Record saved:", result);
        //             savedRecords.push(formData); // Store locally
        //             updateDataTable(); // Refresh table
        //             alert("Record saved successfully!");
        //         } else {
        //             throw new Error(result.message || "Failed to save record");
        //         }
        //     } catch (error) {
        //         console.error("Error saving record:", error);
        //         alert("Error saving record. Please try again.");
        //     }
        //     ipcRenderer.send('save-record', formData);
        // });

document.getElementById('save-print-btn').addEventListener('click', async () => {
    if (!machineSelect.value) {
        alert('Please select a machine first');
        return;
    }

    const formData = {
        machine: machineSelect.value,
        date: new Date(document.getElementById('date').value + 'T00:00:00').toISOString(),
        rollNo: document.getElementById('rollno').value,
        width: parseFloat(document.getElementById('width').value),
        filmMic: parseFloat(document.getElementById('filmmic').value),
        coating: document.getElementById('coating').value,
        colour: document.getElementById('colour').value,
        style: document.getElementById('style').value,
        length: parseFloat(document.getElementById('length').value),
        netWeight: parseFloat(netWeightInput.value),
        coreWeight: parseFloat(coreWeightInput.value),
        grossWeight: parseFloat(grossWeightInput.value),
        operator: document.getElementById('operator').value
    };

    try {
        const response = await fetch('https://deverp.shantipatra.com/api/production-rolls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
            console.log("Record saved:", result);
            savedRecords.push(formData); // Store locally
            updateDataTable(); // Refresh table
            alert("Record saved successfully!");

            // Send to IPC Renderer if applicable
            ipcRenderer.send('save-record', formData);

            // Automatically print the saved record
            generatePrintLayout(formData);
            window.print();
        } else {
            throw new Error(result.message || "Failed to save record");
        }
    } catch (error) {
        console.error("Error saving record:", error);
        alert("Error saving record. Please try again.");
    }
});

        ipcRenderer.on('update-weight', (event, data) => {
            console.log('Received weight data:', data);
            weightDisplay.textContent = `${data.weight} kg`;

            netWeightInput.value = parseFloat(data.weight).toFixed(2); // Set net weight first
            calculateGrossWeight(); // Then calculate correct gross weight

});

        ipcRenderer.on('serial-status', (event, data) => {
            statusDiv.className = data.connected ? 'connected' : 'disconnected';
            statusDiv.textContent = data.connected ? 
                `Connected to ${data.port} (${machineSelect.value})` : 
                'Disconnected';
        });

        document.getElementById('date').valueAsDate = new Date();
        updatePortList();

        window.printRecord = printRecord;
    </script>
    <script>
        const colorOptions = [
            { value: 'transparent', label: 'Transparent' },
            { value: 'brown', label: 'Brown' },
            { value: 'milkyWhite', label: 'Milky White' },
            { value: 'red', label: 'Red' },
            { value: 'blue', label: 'Blue' },
            { value: 'black', label: 'Black' },
            { value: 'green', label: 'Green' },
            { value: 'yellow', label: 'Yellow' },
            { value: 'orange', label: 'Orange' },
            { value: 'purple', label: 'Purple' },
            { value: 'pink', label: 'Pink' },
        ];
    
        const colourDropdown = document.getElementById("colour");
    
        function populateColorDropdown() {
            colorOptions.forEach(color => {
                const option = document.createElement("option");
                option.value = color.value;
                option.textContent = color.label;
                colourDropdown.appendChild(option);
            });
        }
    
        // Populate dropdown on page load
        populateColorDropdown();
    </script>
    
</body>
</html>